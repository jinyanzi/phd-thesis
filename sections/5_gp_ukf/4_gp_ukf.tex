\section{GP-UKF tracker}
\label{sec:gp-ukf}

\subsection{Tracking}

In the tracking setting, the state model is a nonlinear \gls{gp} model while the measurement model is still linear.
\begin{align}
\mathbf{x}_t = & f(\mathbf{x}_{t-1}) = \text{GP}(\mathbf{x_{t-1}}, \mathbf{X}) \\
\mathbf{z}_t = & h(\mathbf{x}_t) = H\mathbf{x}_t,
\end{align}

Similar with \S\ref{sec:tracker-kf}, the observation is still the bounding boxes generated by background subtraction model and vehicle detector, and filtered pixel movement from optical flow: 
$$\mathbf{z}=[x^{bg}, y^{bg}, w^{bg}, h^{bg}, x^{det}, y^{det}, w^{det}, h^{det}, v_x, v_y].$$ 
Similarly, the measurement model $H$ is a $6\times10$ matrix with $1$ at $(0, 0),$ $(1, 1),$ $(2, 2),$ $(3, 3),$ $(0, 4),$ $(1, 5),$ $(2, 6),$ $(3, 7),$ $(4, 8),$ $(5,9)$.

A complete step of the GP-UKF tracker is described in Algorithm \ref{alg:gp-ukf}, which can be adapted to the semantic tracker by substitution of the tracking step in Algorithm \ref{alg:semantic-tracker}.
\begin{algorithm}
\caption{GP-UKF.}\label{alg:gp-ukf}
\begin{algorithmic}[1]
\Require {State transition mapping $\{\mathbf{x}_{t-1}, \mathbf{x}_{t}\}$ from history data.}
\State Start with $\hat{\mathbf{x}}_{0} = \mathbf{x}_{0}$.
\State Calculate the sigma points: $\mathcal{X}_{t-1} = \left[\hat{\mathbf{x}}_{t-1}, \hat{\mathbf{x}}_{t-1}\rpm\sqrt{(d+\lambda)P_{t-1}}\right]$.
\State Predict:
\State{$\begin{aligned} 
\hat{\mathcal{X}}_{i, t} = & \text{GP}_{\mu}(\mathcal{X}_{i, t-1}, \mathbf{X}), \quad i = 0, \dots, 2d\\
\hat{\mathbf{x}}_{t}^{\mhyphen} = & \sum_{i=0}^{2d}{W_i^{(m)}\hat{\mathcal{X}}_{i,t}} \\
P_{t}^{\mhyphen} = & \sum_{i=0}^{2d}{W_i^{(c)}[\hat{\mathcal{X}}_{i,t}-\hat{\mathbf{x}}_t^{\mhyphen}][\hat{\mathcal{X}}_{i,t}-\hat{\mathbf{x}}_t^{\mhyphen}]^T} \\
\hat{\mathcal{Z}}_t = & \left[H\hat{\mathcal{X}}_{i, t}\right], \quad i = 0, \dots, 2d\\
\hat{\mathbf{z}}_t^{\mhyphen} = & \sum_{i=0}^{2d}{W_i^{(m)}\hat{\mathcal{Z}}_{i,t}}
\end{aligned}$}
\State Get measurement covariance of $\mathbf{z}_{t}$: $ R_t = \text{GP}_{\sigma}(\mathbf{z}_t, \mathbf{X})$.
\State Correct with measurement:
\State {$\begin{aligned} 
P_{\hat{\mathbf{z}}_t, \hat{\mathbf{z}}_t} = & \sum_{i=0}^{2d}{W_i^{(c)}[\hat{\mathcal{Z}}_{i,t}-\hat{\mathbf{z}}_t^{\mhyphen}][\hat{\mathcal{Z}}_{i,t}-\hat{\mathbf{z}}_t^{\mhyphen}]^T} + R_t\\
P_{\hat{\mathbf{x}}_t, \hat{\mathbf{z}}_t} = & \sum_{i=0}^{2d}{W_i^{(c)}[\hat{\mathcal{X}}_{i,t}-\hat{\mathbf{x}}_t^{\mhyphen}][\hat{\mathcal{Z}}_{i,t}-\hat{\mathbf{z}}_t^{\mhyphen}]^T} \\
K = & P_{\hat{\mathbf{x}}_t, \hat{\mathbf{z}}_t}P_{\hat{\mathbf{z}}_t, \hat{\mathbf{z}}_t}^{-1}\\
\hat{\mathbf{x}}_t = & \hat{\mathbf{x}}_t^{\mhyphen} + K(\mathbf{z}_t-\hat{\mathbf{z}}_t^{\mhyphen})\\
P_t = & P_t^{\mhyphen} - KP_{\hat{\mathbf{z}}_t, \hat{\mathbf{z}}_t}K^T
\end{aligned}$}
\end{algorithmic}
\end{algorithm}

\subsection{Cold start}
Before any trajectory is available, we track vehicles automatically with the Kalman Filter with the linear model in \ref{sec:tracker-kf}. 
With some accumulated trajectories, the \gls{gp} can predict for objects with similar size and location.
However, the prediction may fail at some unseen data; therefore, it is necessary to assess the quality of the prediction.
We use the covariance of the data point in \ref{eq:gp-cov}, since it measures the certainty of the prediction. 
Upon initialization of an object, \gls{gp}-\gls{ukf} is used only when the obtained covariance is small ($< 0.1$); otherwise, the linear Kalman Filter is used.

% \subsection{Measurement covariance}
% Instead of manual hard-coded measurement covariance in \ref{sec:tracker-kf}, \gls{gp} also helps determine the measurement covariance.
% Similarly, we use \ref{eq:gp-cov} to determine the quality of a measurement covariance .

